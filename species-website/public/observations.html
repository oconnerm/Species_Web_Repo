<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="Luminous Identification">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="assets/ico/favicon.ico">
    <title>Luminous ID - Observation</title>

    <!-- Disable tap highlight on IE -->
    <meta name="msapplication-tap-highlight" content="no">

    <!-- Web Application Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- Add to homescreen for Chrome on Android -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Luminous ID">
    <meta name="theme-color" content="#303F9F">

    <!-- Add to homescreen for Safari on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Luminous ID">
    <meta name="apple-mobile-web-app-status-bar-style" content="#303F9F">

    <!-- Tile icon for Win8 -->
    <meta name="msapplication-TileColor" content="#3372DF">
    <meta name="msapplication-navbutton-color" content="#303F9F">

    <!-- Material Design Lite -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.1.3/material.orange-indigo.min.css">
    <script defer src="https://code.getmdl.io/1.1.3/material.min.js"></script>

    <!-- Custom styles for this template -->
    <link href="https://fonts.googleapis.com/css?family=Snippet" rel="stylesheet">
    <link href="assets/css/bootstrap.css" rel="stylesheet">
    <link href="assets/css/style.css" rel="stylesheet">
  </head>

  <body>

    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="index.html">Luminous ID</a>
        </div>
        <div class="navbar-collapse collapse navbar-right">
          <ul class="nav navbar-nav">
            <li><a href="fieldguide.html">Field Guide</a></li>
            <li><a href="observations.html">Observations</a></li>
            <li><a href="mobileapps.html">Mobile Apps</a></li>
            <li><a href="about.html">About</a></li>
            <li><a href="contact.html">Contact</a></li>
            <li><a href="sisu.html">Sign In/Up</a></li>
          </ul>
        </div>
      </div>
    </div>

	<!-- *****************************************************************************************************************
	 BODY
	 ***************************************************************************************************************** -->
	<div id="twrap">

    <h1 style="text-shadow: 2px 2px #000000">Observations</h1>
    <button id="verified_btn" class="btn btn-action" style="height:32px;width:90px" onclick="showMarkers_verified();">Verified</button>
    <button id="not_verified_btn" class="btn btn-action" style="height:32px;width:120px" onclick="showMarkers_not_verified();">Not Verified</button>
    <button id="all_btn" class="btn btn-action" style="height:32px;width:90px" onclick="showMarkers();">All</button>
    <br></br>
      <div class="home_section" style="min-height: 850px;">
        <br></br>
        <div id="map" style="width:100%;height:300px;background:black"></div>

        <script src="https://www.gstatic.com/firebasejs/3.7.0/firebase.js"></script>
	    <script>
	      // Initialize Firebase
	      var config = {
	        apiKey: "AIzaSyALD0AZe1fPShuzIcNLHh87eERLXXpx3ks",
	        authDomain: "speciesid-ca814.firebaseapp.com",
	        databaseURL: "https://speciesid-ca814.firebaseio.com",
	        storageBucket: "speciesid-ca814.appspot.com",
	        messagingSenderId: "794603922973"
	      };
	      firebase.initializeApp(config);
	    </script>
        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyALD0AZe1fPShuzIcNLHh87eERLXXpx3ks"></script>
        <script>

        // Firebase stuff
        const obs_database = firebase.database().ref("speciesid/observations");
        const acc_database = firebase.database().ref("speciesid/accounts");

        // Researcher Check
        var is_researcher = false;

        // Check for researcher
	  	firebase.auth().onAuthStateChanged(firebaseUser => {
			if (firebaseUser) {

		     	acc_database.once("value").then(function(snapshot) {
		        	snapshot.forEach(function(childSnapshot) {

			        	var user_uid = childSnapshot.getKey();
			    		var researcher_val = childSnapshot.val().researcher;

			        	if (user_uid == firebaseUser.uid) {

			        		if (researcher_val >= 3) {
			        			is_researcher = true;
			        		}
		        		}
		        	});
		      	});
			} 
		});

        // Map, marker arrays, obs array
        var map;
        var verified_markers = [];
        var not_verified_markers = [];
        var observation_array = [];

        function initMap() {

          var verified_btn = document.getElementById('verified_btn');
          var not_verified_btn = document.getElementById('not_verified_btn');
          var all_btn = document.getElementById('all_btn');

          var mapOptions = {
            zoom: 12,
            center: new google.maps.LatLng(40.03287778, -105.5464028),
            styles: [{"featureType":"administrative","elementType":"all","stylers":[{"visibility":"on"},{"color":"#207f35"},{"saturation":"-27"}]},{"featureType":"administrative","elementType":"labels.text.fill","stylers":[{"color":"#ffffff"},{"visibility":"on"}]},{"featureType":"administrative","elementType":"labels.text.stroke","stylers":[{"visibility":"on"},{"color":"#1d7a34"},{"weight":"2.70"}]},{"featureType":"administrative.locality","elementType":"labels.icon","stylers":[{"color":"#ffffff"}]},{"featureType":"landscape","elementType":"all","stylers":[{"color":"#4ca634"},{"visibility":"on"}]},{"featureType":"landscape","elementType":"labels.text","stylers":[{"color":"#ffffff"},{"visibility":"on"}]},{"featureType":"landscape","elementType":"labels.text.stroke","stylers":[{"visibility":"on"},{"lightness":"7"},{"weight":"2.70"},{"color":"#1d7a34"}]},{"featureType":"poi","elementType":"all","stylers":[{"visibility":"on"},{"color":"#71b347"}]},{"featureType":"poi","elementType":"labels.text.fill","stylers":[{"visibility":"on"},{"color":"#ffffff"}]},{"featureType":"poi","elementType":"labels.text.stroke","stylers":[{"visibility":"on"},{"color":"#1d7a34"},{"lightness":"7"},{"weight":"2.70"}]},{"featureType":"poi","elementType":"labels.icon","stylers":[{"visibility":"on"}]},{"featureType":"road","elementType":"all","stylers":[{"saturation":-100},{"lightness":45},{"visibility":"simplified"},{"color":"#c6d19d"}]},{"featureType":"road","elementType":"labels.text","stylers":[{"visibility":"off"},{"color":"#ffffff"}]},{"featureType":"road","elementType":"labels.text.fill","stylers":[{"color":"#ffffff"},{"visibility":"on"}]},{"featureType":"road","elementType":"labels.text.stroke","stylers":[{"visibility":"on"},{"color":"#1d7a34"},{"weight":"1.99"},{"saturation":"0"},{"lightness":"7"}]},{"featureType":"road","elementType":"labels.icon","stylers":[{"visibility":"off"}]},{"featureType":"road.highway","elementType":"all","stylers":[{"visibility":"on"}]},{"featureType":"road.highway","elementType":"labels","stylers":[{"visibility":"on"},{"color":"#d0d0d0"}]},{"featureType":"road.highway","elementType":"labels.text","stylers":[{"visibility":"on"},{"color":"#ffffff"}]},{"featureType":"road.highway","elementType":"labels.text.fill","stylers":[{"weight":"1"},{"saturation":"0"},{"visibility":"on"},{"color":"#ffffff"}]},{"featureType":"road.highway","elementType":"labels.text.stroke","stylers":[{"color":"#1d7a34"},{"lightness":"7"},{"gamma":"1"},{"weight":"1.99"},{"visibility":"on"}]},{"featureType":"road.highway","elementType":"labels.icon","stylers":[{"visibility":"off"},{"color":"#ffffff"}]},{"featureType":"road.arterial","elementType":"labels.icon","stylers":[{"visibility":"off"}]},{"featureType":"road.local","elementType":"all","stylers":[{"visibility":"on"}]},{"featureType":"road.local","elementType":"labels.icon","stylers":[{"visibility":"off"}]},{"featureType":"transit","elementType":"all","stylers":[{"visibility":"off"}]},{"featureType":"water","elementType":"all","stylers":[{"visibility":"on"},{"color":"#e2f9ff"}]},{"featureType":"water","elementType":"labels","stylers":[{"color":"#1f7833"},{"visibility":"on"},{"saturation":"-32"}]}]

          };
          var mapElement = document.getElementById('map');

          map = new google.maps.Map(mapElement, mapOptions);

          // Query obs database
          obs_database.once("value").then(function(snapshot) {
            snapshot.forEach(function(childSnapshot) {

            	var gps_lat = childSnapshot.val().gps_lat;
            	var gps_long = childSnapshot.val().gps_long;
            	var is_verified = childSnapshot.val().is_verified;

           		var uid_timestamp = childSnapshot.getKey();

            	var gps_loc = {lat: gps_lat, lng: gps_long}; 

            	if (is_verified >= 3) {
            		addMarker_verified(gps_loc, map, uid_timestamp);
            	} else {
            		addMarker_not_verified(gps_loc, map, uid_timestamp);
            	}         	

           	});

          });

          // Recent Obs Data

		  var observation_1 = document.getElementById('observation_1');
		  var observation_2 = document.getElementById('observation_2');
		  var observation_3 = document.getElementById('observation_3');

		  var observation_1_name = document.getElementById('observation_1_name');
		  var observation_2_name = document.getElementById('observation_2_name');
		  var observation_3_name = document.getElementById('observation_3_name');

		  var observation_1_img = document.getElementById('observation_1_img');
		  var observation_2_img = document.getElementById('observation_2_img');
		  var observation_3_img = document.getElementById('observation_3_img');

          var recent_obs_data = firebase.database().ref("speciesid/observations").orderByKey();
			recent_obs_data.once("value").then(function(snapshot) {
	        	snapshot.forEach(function(childSnapshot) {

	        		var observation_id = childSnapshot.getKey();

	        		var species_name = childSnapshot.val().species_name;
	            	var username = childSnapshot.val().username;

	        		observation_array.push(observation_id);

					firebase.database().ref("speciesid/observations").once("value").then(function(snapshot) {

						var observation_id = childSnapshot.getKey();

		        		if (observation_array[observation_array.length-1] == observation_id) {

		        			observation_1.textContent = species_name;
		        			observation_1_name.textContent = username;

			        		var storage = firebase.storage();
				            var storageRef = storage.ref();
				            var tangRef = storageRef.child('observations/' + observation_id + '.jpg');

				           	tangRef.getDownloadURL().then(function(url) {
				                document.getElementById('observation_1_img').src = url;
				            })

		        		}
					});

					firebase.database().ref("speciesid/observations").once("value").then(function(snapshot) {

						var observation_id = childSnapshot.getKey();

		        		if (observation_array[observation_array.length-2] == observation_id) {

		        			observation_2.textContent = species_name;
		        			observation_2_name.textContent = username;

			        		var storage = firebase.storage();
				            var storageRef = storage.ref();
				            var tangRef = storageRef.child('observations/' + observation_id + '.jpg');

				           	tangRef.getDownloadURL().then(function(url) {
				                document.getElementById('observation_2_img').src = url;
				            })

		        		}
					});

					firebase.database().ref("speciesid/observations").once("value").then(function(snapshot) {

						var observation_id = childSnapshot.getKey();

		        		if (observation_array[observation_array.length-3] == observation_id) {

		        			observation_3.textContent = species_name;
		        			observation_3_name.textContent = username;

			        		var storage = firebase.storage();
				            var storageRef = storage.ref();
				            var tangRef = storageRef.child('observations/' + observation_id + '.jpg');

				           	tangRef.getDownloadURL().then(function(url) {
				                document.getElementById('observation_3_img').src = url;
				            })

		        		}
					});


	        		console.log(observation_array[observation_array.length-2]);

	        	});
	        });

        }

        function addMarker_verified(location, map, uid_timestamp) {

          var image = 'https://firebasestorage.googleapis.com/v0/b/speciesid-ca814.appspot.com/o/google%20maps%2Fblue_small.png?alt=media&token=6d8ff7ed-ceb4-4e30-b79e-445c54588899';
          var marker = new google.maps.Marker({
            position: location,
            map: map,
            icon: image
          });

          marker.addListener('click', function() {
            map.setCenter(marker.getPosition());

	          var display_recent_observations = document.getElementById('display_recent_observations');
	          var show_recent_observations = document.getElementById('show_recent_observations');
	          var display_species_name = document.getElementById('display_species_name');
	          var obs_image_main = document.getElementById('obs_image');

			  var current_obs = document.getElementById('current_obs');

	          var verify_obs_btn = document.getElementById('verify_obs_btn');
	          var remove_obs_btn = document.getElementById('remove_obs_btn');

	          var display_verified = document.getElementById('display_verified');
	          var display_verified_main = document.getElementById('display_verified_main');
	          var display_username = document.getElementById('display_username');
	          var display_username_main = document.getElementById('display_username_main');
	          var display_datetime = document.getElementById('display_datetime');
	          var display_datetime_main = document.getElementById('display_datetime_main');
	          var display_lat = document.getElementById('display_lat');
	          var display_lat_main = document.getElementById('display_lat_main');
	          var display_long = document.getElementById('display_long');
	          var display_long_main = document.getElementById('display_long_main');
	          var display_comments = document.getElementById('display_comments');
	          var display_comments_main = document.getElementById('display_comments_main');

	        // Query obs database
	          obs_database.once("value").then(function(snapshot) {
	            snapshot.forEach(function(childSnapshot) {

	            	var comments = childSnapshot.val().comments;
	            	var gps_lat = childSnapshot.val().gps_lat;
	            	var gps_long = childSnapshot.val().gps_long;
	            	var is_verified = childSnapshot.val().is_verified;
	            	var species_name = childSnapshot.val().species_name;
	            	var username = childSnapshot.val().username;
	            	var timestamp = childSnapshot.val().datetime;

	            	var uid_timestamp_true = childSnapshot.getKey();

			        var storage = firebase.storage();
		            var storageRef = storage.ref();
		            var tangRef = storageRef.child('observations/' + uid_timestamp + '.jpg');

		            if (uid_timestamp == uid_timestamp_true) {

			            tangRef.getDownloadURL().then(function(url) {
			                document.getElementById('obs_image').src = url;
			            })

			            display_species_name.textContent = species_name;
			            display_username.textContent = username;
			            display_datetime.textContent = timestamp;
			            display_lat.textContent = gps_lat;
			            display_long.textContent = gps_long;
			            display_comments.textContent = comments;

			           	current_obs.textContent = uid_timestamp_true;

		            }

	           	});

	          });

	        display_recent_observations.classList.add('hide');
	       	show_recent_observations.classList.add('hide');
            display_species_name.classList.remove('hide');
            obs_image_main.classList.remove('hide');

            if (is_researcher) {
            	verify_obs_btn.classList.remove('hide');
            } else {
            	verify_obs_btn.classList.add('hide');
            }
            //remove_obs_btn.classList.remove('hide');

			display_not_verified.classList.add('hide');
            display_verified.classList.remove('hide');
            display_verified_main.classList.remove('hide');
            display_username.classList.remove('hide');
            display_username_main.classList.remove('hide');
            display_datetime.classList.remove('hide');
            display_datetime_main.classList.remove('hide');
            display_lat.classList.remove('hide');
            display_lat_main.classList.remove('hide');
            display_long.classList.remove('hide');
            display_long_main.classList.remove('hide');
            display_comments.classList.remove('hide');
            display_comments_main.classList.remove('hide');

          });

          verified_markers.push(marker);
        }

        function addMarker_not_verified(location, map, uid_timestamp) {

          var image = 'https://firebasestorage.googleapis.com/v0/b/speciesid-ca814.appspot.com/o/google%20maps%2Fred_small.png?alt=media&token=b8887eec-5075-422f-a515-ba4bce116f0d';
          var marker_not_ver = new google.maps.Marker({
            position: location,
            map: map,
            icon: image
          });

          marker_not_ver.addListener('click', function() {
            map.setCenter(marker_not_ver.getPosition());

	          var display_recent_observations = document.getElementById('display_recent_observations');
	          var show_recent_observations = document.getElementById('show_recent_observations');
	          var display_species_name = document.getElementById('display_species_name');
			  var obs_image_main = document.getElementById('obs_image');

			  var current_obs = document.getElementById('current_obs');

	          var verify_obs_btn = document.getElementById('verify_obs_btn');
	          var remove_obs_btn = document.getElementById('remove_obs_btn');

	          var display_not_verified = document.getElementById('display_not_verified');
	          var display_verified_main = document.getElementById('display_verified_main');
	          var display_username = document.getElementById('display_username');
	          var display_username_main = document.getElementById('display_username_main');
	          var display_datetime = document.getElementById('display_datetime');
	          var display_datetime_main = document.getElementById('display_datetime_main');
	          var display_lat = document.getElementById('display_lat');
	          var display_lat_main = document.getElementById('display_lat_main');
	          var display_long = document.getElementById('display_long');
	          var display_long_main = document.getElementById('display_long_main');
	          var display_comments = document.getElementById('display_comments');
	          var display_comments_main = document.getElementById('display_comments_main');

	        // Query obs database
	          obs_database.once("value").then(function(snapshot) {
	            snapshot.forEach(function(childSnapshot) {

	            	var comments = childSnapshot.val().comments;
	            	var gps_lat = childSnapshot.val().gps_lat;
	            	var gps_long = childSnapshot.val().gps_long;
	            	var is_verified = childSnapshot.val().is_verified;
	            	var species_name = childSnapshot.val().species_name;
	            	var username = childSnapshot.val().username;
	            	var timestamp = childSnapshot.val().datetime;

	            	var uid_timestamp_true = childSnapshot.getKey();

	            	var storage = firebase.storage();
		            var storageRef = storage.ref();
		            var tangRef = storageRef.child('observations/' + uid_timestamp + '.jpg');

		            if (uid_timestamp == uid_timestamp_true) {

			            tangRef.getDownloadURL().then(function(url) {
			                document.getElementById('obs_image').src = url;
			            })

			            display_species_name.textContent = species_name;
			            display_username.textContent = username;
			            display_datetime.textContent = timestamp;
			            display_lat.textContent = gps_lat;
			            display_long.textContent = gps_long;
			            display_comments.textContent = comments;

			            current_obs.textContent = uid_timestamp_true;

		            }

	           	});

	          });

	        display_recent_observations.classList.add('hide');
	        show_recent_observations.classList.add('hide');
            display_species_name.classList.remove('hide');
			obs_image_main.classList.remove('hide');

            if (is_researcher) {
            	verify_obs_btn.classList.remove('hide');
            } else {
            	verify_obs_btn.classList.add('hide');
            }
            //remove_obs_btn.classList.remove('hide');

            display_verified.classList.add('hide');
            display_not_verified.classList.remove('hide');
            display_verified_main.classList.remove('hide');
            display_username.classList.remove('hide');
            display_username_main.classList.remove('hide');
            display_datetime.classList.remove('hide');
            display_datetime_main.classList.remove('hide');
            display_lat.classList.remove('hide');
            display_lat_main.classList.remove('hide');
            display_long.classList.remove('hide');
            display_long_main.classList.remove('hide');
            display_comments.classList.remove('hide');
            display_comments_main.classList.remove('hide');

          });

          not_verified_markers.push(marker_not_ver);
        }

        function setMap_verfied(map) {
          for (var i = 0; i < verified_markers.length; i++) {
            verified_markers[i].setMap(map);
          }
        }

        function setMap_not_verfied(map) {
          for (var i = 0; i < not_verified_markers.length; i++) {
            not_verified_markers[i].setMap(map);
          }
        }

        function showMarkers_verified() {
          setMap_verfied(map);
          setMap_not_verfied(null);
        }

        function showMarkers_not_verified() {
          setMap_verfied(null);
          setMap_not_verfied(map);
        }

        function showMarkers() {
          setMap_verfied(map);
          setMap_not_verfied(map);
        }

        function verify_obs_func() {

          var uid_timestamp = document.getElementById('current_obs').textContent;

          obs_database.once("value").then(function(snapshot) {
            snapshot.forEach(function(childSnapshot) {

            	var uid_timestamp_true = childSnapshot.getKey();

	            if (uid_timestamp == uid_timestamp_true) {

	                var verify_number = childSnapshot.val().is_verified;

	                verify_number = verify_number + 1;

	                firebase.database().ref("speciesid/observations").child(uid_timestamp).update({
	                  "is_verified": verify_number
	                });
	            }
           	});
          });

          alert("Observation verified! (Need 3)");

        }

        google.maps.event.addDomListener(window, 'load', initMap);

        </script>
        <h2 id="display_recent_observations" style="text-align:center;color:#dddddd;">Recent Observations</h2>

        <div id="show_recent_observations" style="clear:both;">
			<div id="container_obs">
				<h3><span id="observation_1" class="columnh2_obs"></span><img id="observation_1_img" class="img_obs" border="0" width="80" height="80"/><br/><br/><br/><br/><br/><span id="observation_1_name" class="columnh2_obs"></span></h3>
				<h3><span id="observation_2" class="columnh2_obs"></span><img id="observation_2_img" class="img_obs" border="0" width="80" height="80"/><br/><br/><br/><br/><br/><span id="observation_2_name" class="columnh2_obs"></span></h3>
				<h3><span id="observation_3" class="columnh2_obs"></span><img id="observation_3_img" class="img_obs" border="0" width="80" height="80"/><br/><br/><br/><br/><br/><span id="observation_3_name" class="columnh2_obs"></span></h3>
			</div>
        </div>

        <h2 id="display_species_name" class="hide" style="text-align:center;color:#dddddd;"></h2>

        <div align="left" style="float:left;width:50%;">

          <h4 id="current_obs" class="hide"></h4>

          <div style="clear:both;">
            <img id="obs_image" class="hide" style="vertical-align:middle;height:250px;width:315px"/>
       	    <h4 id="display_verified_main" class="hide" style="text-align:center;color:#dddddd;">Verified:</h4>
      		<img src="assets/img/check.png" id="display_verified" class="icons hide" style="vertical-align:middle;">
      		<img src="assets/img/x.png" id="display_not_verified" class="icons hide" style="vertical-align:middle;">
          </div>
          <br></br>
          <div style="clear: both;text-align: center;">
          	<button id="verify_obs_btn" class="btn btn-action hide" style="height:32px;width:120px" onclick="verify_obs_func();">Verify</button>
          	<!--
    	  	<button id="remove_obs_btn" class="btn btn-action hide" style="height:32px;width:120px">Remove</button>
    	  	-->
    	  </div>

        </div>
        <div align="right" style="float:right;width:50%;padding:0px 65px">

          <div style="clear: both">
          	<h4 id="display_username_main" class="hide" style="float:left;color:#dddddd;">User:</h4>
            <h5 id="display_username" style="float:right;width:50%;"></h5>
          </div>

          <div style="clear: both">
          	<h4 id="display_datetime_main" class="hide" style="float:left;color:#dddddd;">Date:</h4>
            <h5 id="display_datetime" style="float:right;width:50%;"></h5>
          </div>

          <div style="clear: both">
          	<h4 id="display_lat_main" class="hide" style="float:left;color:#dddddd;">Latitude:</h4>
            <h5 id="display_lat" style="float:right;width:50%;"></h5>
          </div>

          <div style="clear: both">
          	<h4 id="display_long_main" class="hide" style="float:left;color:#dddddd;">Longitude:</h4>
            <h5 id="display_long" style="float:right;width:50%;"></h5>
          </div>

          <div style="clear: both">
          	<h4 id="display_comments_main" class="hide" style="float:left;color:#dddddd;">Comments:</h4>
            <h5 id="display_comments" style="float:right;width:50%;"></h5>
          </div>
        </div>
      </div>  
	 </div>
  </body>
</html>
